---
- name: Install ollama cask
  homebrew_cask:
    name: "ollama"
    state: present
    greedy: yes
  register: ollama_installed

- name: Open Ollama for the first time
  shell: open /Applications/Ollama.app
  when: ollama_installed.changed

- name: Verify OLLAMA_HOST environment variable
  shell: launchctl getenv OLLAMA_HOST
  register: ollama_host_env
  changed_when: no

- name: Set OLLAMA_HOST environment variable
  shell: launchctl setenv OLLAMA_HOST "0.0.0.0"
  when: ollama_expose and ('0.0.0.0' not in ollama_host_env.stdout)

- name: Ensure ollama is running the latest
  shell: |
    killall Ollama
    sleep 5
    open -a Ollama
  changed_when: no

- name: Pull the models
  shell: ollama pull {{ item }} &
  loop: "{{ ollama_models }}"