---
# zprofile baseline
- name: Ensure common directories exist
  include_tasks: common_directories.yml

- name: Remove old poetry preferences file
  file:
    path: "{{ ansible_user_dir }}/Library/Preferences/pypoetry"
    state: absent

- name: zprofile baseline for Apple Silicon
  lineinfile:
    line: eval "$(/opt/homebrew/bin/brew shellenv)"
    path: $HOME/.zprofile
    create: yes
  when: ansible_architecture == 'arm64'

- name: Additional zprofile baseline
  blockinfile:
    block: |
      {{ lookup("template", "templates/.zprofile") }}
    path: $HOME/.zprofile
    marker: "### {mark} PJ zprofile baseline ###"
    create: yes

- name: Additional user zprofile baseline
  blockinfile:
    block: "{{ zprofile_user }}"
    path: $HOME/.zprofile
    marker: "### {mark} USER zprofile baseline ###"

- name: Configure git
  include_tasks: git_config.yml
  when: git_config is defined

- name: Git checkout
  include_tasks: git_repos.yml
  vars:
    repos: '{{ developer_repos }}'

- name: Git checkout
  include_tasks: git_repos.yml
  vars:
    repos: '{{ user_repos }}'
  when: user_repos is defined

- name: setup .npmrc and pip auth with keystone
  template:
    src: .npmrc
    dest: '{{ ansible_user_dir }}/'
  when: gitlab_api_token != "please_update_user_yml"

- name: setup pip conf
  template:
    src: pip.conf
    dest: '{{ ansible_user_dir }}/.config/pip/'
  when: gitlab_api_token != "please_update_user_yml"

- name: setup /etc/hosts
  lineinfile:
    path: /etc/hosts
    state: present
    search_string: '127.0.0.1'
    line: "127.0.0.1  localhost {{ localhost_aliases | join(' ') }}"
  become: true

- name: setup powershell
  include_tasks: powershell.yml

#- name: Remove sudo from pam.d
#  lineinfile:
#    line: auth       sufficient     pam_tid.so
#    path: /etc/pam.d/sudo
#    state: absent
#  become: yes

#- name: Remove old 10 addresses from hosts
#  lineinfile:
#    regexp: '^10.*'
#    path: /etc/hosts
#    state: absent
#  become: yes

- name: Trackpad 3 Finger Drag
  community.general.osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: TrackpadThreeFingerDrag
    type: int
    value: "{{ three_finger_drag|int }}"
    state: present

- name: Trackpad Single Touch Tap - AppleMultitouchTrackpad
  community.general.osx_defaults:
    domain: com.apple.AppleMultitouchTrackpad
    key: Clicking
    type: int
    value: "{{ single_touch_tap|int }}"
    state: present

- name: Trackpad Single Touch Tap - AppleBluetoothMultitouch
  community.general.osx_defaults:
    domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
    key: Clicking
    type: int
    value: "{{ single_touch_tap|int }}"
    state: present

#- name: Finder search within current folder
#  community.general.osx_defaults:
#    domain: com.apple.finder
#    key: FXDefaultSearchScope
#    type: string
#    value: "{{ search_folder }}"
#    state: present

- name: Finder Show Status Bar
  community.general.osx_defaults:
    domain: com.apple.finder
    key: ShowStatusBar
    type: int
    value: "{{ show_status_bar|int }}"
    state: present

- name: Default Finder Location
  community.general.osx_defaults:
    domain: com.apple.finder
    key: NewWindowTarget
    type: string
    value: "{{ new_window_target }}"
    state: present

#- name: Safari show Developer Menu
#  community.general.osx_defaults:
#    domain: com.apple.Safari
#    key: IncludeInternalDebugMenu
#    type: bool
#    value: "{{ safari_developer_menu }}"
#    state: present
- name: Create SSH Tunnel file
  lineinfile:
    line: "#!/bin/bash"
    mode: '0740'
    create: yes
    path: "{{ ansible_user_dir }}/tunnels.sh"
  when: (ssh_tunnels | length>0)

- name: Add SSH Tunnels to Tunnels file
  lineinfile:
    line: "ssh -f -N -L {{ item.port }}:127.0.0.1:5900 {{ item.host }} &"
    path: "{{ ansible_user_dir }}/tunnels.sh"
  when: (ssh_tunnels | length>0)
  loop: "{{ ssh_tunnels }}"

- name: Add caffeinate to tunnels.shd
  lineinfile:
    line: "caffeinate -d"
    path: "{{ ansible_user_dir }}/tunnels.sh"
  when: (ssh_tunnels | length>0)